var exam_list = [
    {"treatment": "CT", "category": "ABD", "xls_exam": "CT pelvis 無造影劑"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT upper Abd.無造影劑"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT lower Abd.無造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT brain無造影劑"},
{"treatment": "CT", "category": "Chest", "xls_exam": "CT chest無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT arm無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT forearm無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT femur無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT foot無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT hand無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT hip無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT knee無造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT L-spine無造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT sacrum無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT shoulder無造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT sinuses無造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT T-spine無造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT neck無造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT orbital無造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT C-spine無造影劑"},
{"treatment": "CT", "category": "LDCT", "xls_exam": "肺部低劑量CT(自費)"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT Whole Abd無造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT parotid gland無造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT thyroid gland無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT Leg無造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT Ankle無造影劑"},
{"treatment": "CT", "category": "Chest", "xls_exam": "CT ches無造影劑(體檢"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT elbow無造影劑"},
{"treatment": "CT", "category": "LDCT", "xls_exam": "肺部低劑量CT(體檢)"},
{"treatment": "CT", "category": "LDCT", "xls_exam": "肺部低劑量CT(員工)"},
{"treatment": "CT", "category": "LDCT", "xls_exam": "肺部低劑量CT(專案)"},
{"treatment": "CT", "category": "LDCT", "xls_exam": "肺部低劑量CT(支援)"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT thoracic spine(有/無劑)"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT upper Abd.(有/無劑)"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT lower Abd.(有/無劑)"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT brain(有/無劑)"},
{"treatment": "CT", "category": "Chest", "xls_exam": "CT chest(有/無劑)"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT arm(有/無劑)"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT forearm(有/無劑)"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT femur(有/無劑)"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT foot(有/無劑)"},
{"treatment": "CT", "category": "其他", "xls_exam": "CT knee(有/無劑)"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT orbital(有/無劑)"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT Pelvis(有/無劑)"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT parotid (有/無劑)"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT thyroid(有/無劑)"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT neck(有/無劑)"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT lumbar(有/無劑)"},
{"treatment": "CT", "category": "Brain", "xls_exam": "CT sinuses(有/無劑)"},
{"treatment": "CT", "category": "Spine", "xls_exam": "CT c-spine(有/無劑)"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT Whole Abd(有/無劑)"},
{"treatment": "CT", "category": "ABD", "xls_exam": "pelvis 有造影劑"},
{"treatment": "CT", "category": "ABD", "xls_exam": "abdomen upper有造影劑"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT lower abdomen 有造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "brain有造影劑"},
{"treatment": "CT", "category": "ABD", "xls_exam": "CT Whole Abd有造影劑 "},
{"treatment": "CT", "category": "其他", "xls_exam": "arm有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "forearm有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "femur有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "foot有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "hand有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "hip有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "knee有造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "lumbar spine有造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "sacrum有造影劑"},
{"treatment": "CT", "category": "其他", "xls_exam": "shoulder有造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "sinuses有造影劑"},
{"treatment": "CT", "category": "Spine", "xls_exam": "thoracic spine有造影"},
{"treatment": "CT", "category": "Brain", "xls_exam": "neck有造影劑"},
{"treatment": "CT", "category": "Brain", "xls_exam": "orbital有造影劑"},
{"treatment": "CT", "category": "Chest", "xls_exam": "CT chest有造影劑"},
{"treatment": "CT", "category": "L-S", "xls_exam": "OS-腰椎"},
{"treatment": "CT", "category": "HiP", "xls_exam": "OS-腰椎&右側髖關節"},
{"treatment": "CT", "category": "HiP", "xls_exam": "OS-腰椎&左側髖關節"},
{"treatment": "CT", "category": "L+HIP", "xls_exam": "OS-腰椎&兩側髖關節"},
{"treatment": "CT", "category": "HiP", "xls_exam": "OS-兩側髖關節"},
{"treatment": "CT", "category": "HiP", "xls_exam": "OS-右側髖關節"},
{"treatment": "CT", "category": "HiP", "xls_exam": "OS-左側髖關節"},
{"treatment": "CT", "category": "WB", "xls_exam": "OS-全身(Whole body)"},
{"treatment": "CT", "category": "WB", "xls_exam": "OS-(全身)代檢-無齡診所"},
{"treatment": "CT", "category": "IVP", "xls_exam": "I.V.P"},
{"treatment": "CT", "category": "IVP", "xls_exam": "I.V.P with cystogram"},
{"treatment": "CT", "category": "GI", "xls_exam": "Esophagogram"},
{"treatment": "CT", "category": "GI", "xls_exam": "Upper G-I series"},
{"treatment": "CT", "category": "GI", "xls_exam": "small bowel  study"},
{"treatment": "CT", "category": "MAMMO", "xls_exam": "乳房造影術Mammograp"},
{"treatment": "CT", "category": "MAMMO", "xls_exam": "婦女乳房檢查服務"},
{"treatment": "CT", "category": "MAMMO", "xls_exam": "婦女乳房檢查服務"},
{"treatment": "CT", "category": "MAMMO", "xls_exam": "Spot Magnification放大攝影"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest PA"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest RT LAT"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest LT LAT"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest RT OBL"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest LT OBL"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest Lordotic View"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest RT Decubitus"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Chest LT Decubitus"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Ribs RT"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Ribs LT"},
{"treatment": "CT", "category": "胸部", "xls_exam": "Sternum"},
{"treatment": "CT", "category": "腹部", "xls_exam": "KUB"},
{"treatment": "CT", "category": "腹部", "xls_exam": "abdomen supin "},
{"treatment": "CT", "category": "腹部", "xls_exam": "abdomen standing"},
{"treatment": "CT", "category": "腹部", "xls_exam": "abdomen RT Decubitus"},
{"treatment": "CT", "category": "腹部", "xls_exam": "abdomen LT Decubitus"},
{"treatment": "CT", "category": "頭部", "xls_exam": "skull 1 view"},
{"treatment": "CT", "category": "頭部", "xls_exam": "skull pa,lat"},
{"treatment": "CT", "category": "頭部", "xls_exam": "skull basol"},
{"treatment": "CT", "category": "頭部", "xls_exam": "skull town's"},
{"treatment": "CT", "category": "頭部", "xls_exam": "skull Water's"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Mandible RT"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Mandible LT"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Mastoid"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Nasal bone"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Optic foramen"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Orbital"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Petrous"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Sella turcica"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Sinuses"},
{"treatment": "CT", "category": "頭部", "xls_exam": "Zygomatic bone"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Cervical 2View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Cervical 4View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "thoracic 2View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "thoracic 4View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar LatView"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar 2View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar 4View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Sacrum"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "coccyx"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "thoracic 1View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar 1View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "whole spine APview"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar extension Vie"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar flexion View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Cervical 3View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "thoracic 3View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "lumbar 3View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Cervical 1View"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "T-L SPINE  2VIEW"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "whole spine Lat view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Clavicle RT 1 view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Clavicle LT 1 view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Scapula RT Y view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Scapula LT Y view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Shoulder RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Shoulder LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Clavicle RT 2 view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Clavicle LT 2 view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Scapula LT 2 view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Scapula RT 2 view"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "L't Shoulder AP"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "L't Shoulder Lat"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "L't Shoulder Axial"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "R't Shoulder AP"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "R't Shoulder Lat"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "R't Shoulder Axial"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Arm RT (Humerus)"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Arm LT (Humerus)"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Elbow RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Elbow LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Forearm RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Forearm LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Hand RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Hand LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Wrist RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Wrist LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Scaphoid bone RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Scaphoid bone LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "bone age"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Femur RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Femur LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Foot RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Foot LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Heel RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Heel LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Knee RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Knee LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Leg RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Leg LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Tangential For RT Pa"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Tangential For LT Pa"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Ankle RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Ankle LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Both knee AP"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "R'T knee lat"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "L'T knee  lat"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "關節測量術"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "pelvis"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Hip RT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Hip LT"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Both hip AP"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Both Hip lat(Frog)"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Hip RT  lat"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "Hip LT  lat"},
{"treatment": "CT", "category": "四肢關節", "xls_exam": "關節測量術"}
];

// delete a specific row
function clamp_range(range) {
    if(range.e.r >= (1<<20)) range.e.r = (1<<20)-1;
    if(range.e.c >= (1<<14)) range.e.c = (1<<14)-1;
    return range;
}

var crefregex = /(^|[^._A-Z0-9])([$]?)([A-Z]{1,2}|[A-W][A-Z]{2}|X[A-E][A-Z]|XF[A-D])([$]?)([1-9]\d{0,5}|10[0-3]\d{4}|104[0-7]\d{3}|1048[0-4]\d{2}|10485[0-6]\d|104857[0-6])(?![_.\(A-Za-z0-9])/g;

/*
    deletes `nrows` rows STARTING WITH `start_row`
    - ws         = worksheet object
    - start_row  = starting row (0-indexed) | default 0
    - nrows      = number of rows to delete | default 1
*/

function delete_rows(ws, start_row, nrows) {
    if(!ws) throw new Error("operation expects a worksheet");
    var dense = Array.isArray(ws);
    if(!nrows) nrows = 1;
    if(!start_row) start_row = 0;

    /* extract original range */
    var range = XLSX.utils.decode_range(ws["!ref"]);
    var R = 0, C = 0;

    var formula_cb = function($0, $1, $2, $3, $4, $5) {
        var _R = XLSX.utils.decode_row($5), _C = XLSX.utils.decode_col($3);
        if(_R >= start_row) {
            _R -= nrows;
            if(_R < start_row) return "#REF!";
        }
        return $1+($2=="$" ? $2+$3 : XLSX.utils.encode_col(_C))+($4=="$" ? $4+$5 : XLSX.utils.encode_row(_R));
    };

    var addr, naddr;
    /* move cells and update formulae */
    if(dense) {
        for(R = start_row + nrows; R <= range.e.r; ++R) {
            if(ws[R]) ws[R].forEach(function(cell) { cell.f = cell.f.replace(crefregex, formula_cb); });
            ws[R-nrows] = ws[R];
        }
        ws.length -= nrows;
        for(R = 0; R < start_row; ++R) {
            if(ws[R]) ws[R].forEach(function(cell) { cell.f = cell.f.replace(crefregex, formula_cb); });
        }
    } else {
        for(R = start_row + nrows; R <= range.e.r; ++R) {
            for(C = range.s.c; C <= range.e.c; ++C) {
                addr = XLSX.utils.encode_cell({r:R, c:C});
                naddr = XLSX.utils.encode_cell({r:R-nrows, c:C});
                if(!ws[addr]) { delete ws[naddr]; continue; }
                if(ws[addr].f) ws[addr].f = ws[addr].f.replace(crefregex, formula_cb);
                ws[naddr] = ws[addr];
            }
        }
        for(R = range.e.r; R > range.e.r - nrows; --R) {
            for(C = range.s.c; C <= range.e.c; ++C) {
                addr = XLSX.utils.encode_cell({r:R, c:C});
                delete ws[addr];
            }
        }
        for(R = 0; R < start_row; ++R) {
            for(C = range.s.c; C <= range.e.c; ++C) {
                addr = XLSX.utils.encode_cell({r:R, c:C});
                if(ws[addr] && ws[addr].f) ws[addr].f = ws[addr].f.replace(crefregex, formula_cb);
            }
        }
    }

    /* write new range */
    range.e.r -= nrows;
    if(range.e.r < range.s.r) range.e.r = range.s.r;
    ws["!ref"] = XLSX.utils.encode_range(clamp_range(range));

    /* merge cells */
    if(ws["!merges"]) ws["!merges"].forEach(function(merge, idx) {
        var mergerange;
        switch(typeof merge) {
            case 'string': mergerange = XLSX.utils.decode_range(merge); break;
            case 'object': mergerange = merge; break;
            default: throw new Error("Unexpected merge ref " + merge);
        }
        if(mergerange.s.r >= start_row) {
            mergerange.s.r = Math.max(mergerange.s.r - nrows, start_row);
            if(mergerange.e.r < start_row + nrows) { delete ws["!merges"][idx]; return; }
        } else if(mergerange.e.r >= start_row) mergerange.e.r = Math.max(mergerange.e.r - nrows, start_row);
        clamp_range(mergerange);
        ws["!merges"][idx] = mergerange;
    });
    if(ws["!merges"]) ws["!merges"] = ws["!merges"].filter(function(x) { return !!x; });
    
    /* rows */
    if(ws["!rows"]) ws["!rows"].splice(start_row, nrows);
}



function handleFile() {
    const fileInput = document.getElementById('fileInput');
    
    if (fileInput.files.length === 0) {
        console.log('沒有選擇任何檔案');
        return;
    }

    var total_exams_counts=0;
    var exams_counts={'辨識異常':0};
    var group_counts={};
    var counts_html = "";
    var group_html = "";
    var excel_table = $("#excel_table");
    var col_key=' 檢查部位';
    var col_date_key='日期'
    var jsonData=[];
    var processed_ws;
    var htmlTable;
    var total_files=0;
    
    // 建立groups
    //exam_list.map(function(exam){ group_counts[i++]={"category":exam["category"]};});
    exam_list.map(function(exam){ group_counts[exam["category"]]={};});

    // 清空excel table
    excel_table.empty();

    // 建立一個陣列來存放所有檔案的Promise
    const filePromises = [];

    // 逐一處理每個檔案
    for (const file of fileInput.files) {
        const fileReader = new FileReader();
    
        total_files++;
        console.log("read file ["+total_files+"].");

        // 定義當檔案讀取完成時的處理函式
        const filePromise = new Promise((resolve, reject) => {
            fileReader.onload = (event) => {
                const contents = event.target.result;
                
                const workbook = XLSX.read(contents, {type: 'array'});
                //const sheetName = workbook.SheetNames[0];
                //const worksheet = workbook.Sheets[sheetName];
                
                // sheet迴圈
                for(const sheet_name of workbook.SheetNames) {
                    if(!(sheet_name.includes("門診") || sheet_name.includes("住診")))
                        continue;

                    const worksheet = workbook.Sheets[sheet_name];
                    
                    // 首先移除不需要的前幾項
                    delete_rows(worksheet, 0, 3);

                    // 先轉為json
                    jsonData=jsonData.concat(XLSX.utils.sheet_to_json(worksheet));
                    resolve(contents);
                }

                
            };

            // 處理讀取檔案時的錯誤
            fileReader.onerror = (event) => {
                reject(event.target.error);
            };
        });

        // 開始讀取檔案
        fileReader.readAsArrayBuffer(file);
        filePromises.push(filePromise);
      }
    
    // 等待所有檔案都讀取完成
    return Promise.all(filePromises)
        .then((fileContents) => {
            // 處理資料: sorting
            jsonData.sort((a, b) => {           
                    return a[col_key].localeCompare(b[col_key]);
            });
                
                
            // people counting 
            jsonData.map(function(obj){

                var is_match=false;

                exam_list.map(function(exam){
                    if(exam["xls_exam"] == obj[col_key]) {
                        is_match = true;
                        if (!exams_counts.hasOwnProperty(obj[col_key])) {
                            exams_counts[obj[col_key]] = 0;
                        }
                        exams_counts[obj[col_key]] += 1;
                        obj['辨識異常'] = "";
                        if (!group_counts[exam["category"]].hasOwnProperty(obj[col_date_key])) {
                            group_counts[exam["category"]][obj[col_date_key]] = 0;
                        }
                        group_counts[exam["category"]][obj[col_date_key]] += 1;
                    }
                });

                if (!is_match) {
                    exams_counts['辨識異常']+=1;
                    obj['辨識異常'] = "清單內沒有此檢查部位";
                }

            });
            
            // 再轉回sheet
            processed_ws = XLSX.utils.json_to_sheet(jsonData);
            
            // show result of people counting
            counts_html='<div style="border-style: solid;">';
            
            // 針對結果排序
            var ordered_counts = Object.keys(exams_counts).sort().reduce(
              (obj, key) => { 
                obj[key] = exams_counts[key]; 
                return obj;
              }, 
              {}
            );
            
            for (const [key, value] of Object.entries(ordered_counts)) {
              counts_html+='<div>'+key+'：'+value+'</div>';
              total_exams_counts+=value;
            }
            
            counts_html+='</div>';
            
            // 加上總數
            counts_html = '<div>Total: '+total_exams_counts+'</div>'+counts_html;
            excel_table.append($(counts_html));

            // group counts
            // group_html = '<div>';
            // for (const [key, value] of Object.entries(group_counts)) {
            //     group_html+='<div>'+key+'：'+value+'</div>';
            // }
            // group_html += '</div>';
            // excel_table.append($(group_html));

            //TODO
            // var i = 0,num_rows_group={};
            // group_counts.map(function(group){
            //     num_rows_group[i] = {
            //         ordered_groups[i]: 1};
            // });

            //var ws=XLSX.utils.json_to_sheet(group_counts);

            // show table
            htmlTable = XLSX.utils.sheet_to_html(processed_ws);
            excel_table.append($(htmlTable));
        })
        .catch((error) => {
            console.error('讀取檔案時發生錯誤:', error);
        });
}


var ordered_groups = [
    "頭部",
    "胸部",
    "腹部",
    "四肢關節",
    "I.V.P",
    "G.I",
    "Colon",
    "MAMMO",
    "Brain",
    "Chest",
    "LDCT",
    "ABD",
    "Spine",
    "其他",
    "L-S",
    "HiP",
    "L+HIP",
    "WB"
]


var test_json=[
    {
        "日期": "113/01/30",
        "病歷號碼": "A0304525",
        "姓名": "熊珮妏",
        "性別": "女",
        "年齡": 25,
        " 檢查部位": "Chest PA",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "A0304526",
        "姓名": "黃品寬",
        "性別": "男",
        "年齡": 23,
        " 檢查部位": "Chest PA",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "A0304530",
        "姓名": "吳尚謙",
        "性別": "男",
        "年齡": 25,
        " 檢查部位": "Chest PA",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "A0304531",
        "姓名": "康芷菱",
        "性別": "女",
        "年齡": 30,
        " 檢查部位": "Chest PA",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "A0304532",
        "姓名": "林仁森",
        "性別": "男",
        "年齡": 63,
        " 檢查部位": "Chest PA",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "c000001460",
        "姓名": "楊凡儀",
        "性別": "女",
        "年齡": 47,
        " 檢查部位": "CHEST(自費)",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 400,
        "    成數": 100,
        "    總價": 400,
        "開單醫師": 999,
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1300041",
        "姓名": "張美媛",
        "性別": "女",
        "年齡": 62,
        "病床": "622B",
        " 檢查部位": "lumbar 2View",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "總價": 0,
        "開單醫師": "林恩能",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1300173",
        "姓名": "王復國",
        "性別": "男",
        "年齡": 72,
        "病床": "620B",
        " 檢查部位": "lumbar 2View",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "總價": 0,
        "開單醫師": "林恩能",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1115722",
        "姓名": "盛立基",
        "性別": "男",
        "年齡": 62,
        " 檢查部位": "lumbar 2View",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "簡清賢",
        "報告醫師": "李瑞華",
        "辨識異常": ""
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1280360",
        "姓名": "謝芳蒨",
        "性別": "女",
        "年齡": 61,
        " 檢查部位": "MRI without contrast",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 6500,
        "    成數": 100,
        "    總價": 6500,
        "開單醫師": "林恩能",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1299893",
        "姓名": "許湘函",
        "性別": "女",
        "年齡": 36,
        " 檢查部位": "MRI without contrast",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 6500,
        "    成數": 100,
        "    總價": 6500,
        "開單醫師": "林恩能",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1300175",
        "姓名": "李界佳",
        "性別": "男",
        "年齡": 71,
        " 檢查部位": "MRI without contrast",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 6500,
        "    成數": 100,
        "    總價": 6500,
        "開單醫師": "林恩能",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1301084",
        "姓名": "徐千枝",
        "性別": "女",
        "年齡": 82,
        " 檢查部位": "MRI without contrast",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 6500,
        "    成數": 100,
        "    總價": 6500,
        "開單醫師": "林恩能",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1301288",
        "姓名": "鄧加明",
        "性別": "男",
        "年齡": 20,
        " 檢查部位": "MRI without contrast",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 8000,
        "    成數": 100,
        "    總價": 8000,
        "開單醫師": "花世源",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1855151",
        "姓名": "康嘉琦",
        "性別": "女",
        "年齡": 44,
        " 檢查部位": "OS(全身)代檢無齡診所",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": 999,
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "277827",
        "姓名": "李逸橿",
        "性別": "男",
        "年齡": 67,
        " 檢查部位": "Plain K.U.B.",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 400,
        "    成數": 100,
        "    總價": 400,
        "開單醫師": "張孝欽",
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "968342",
        "姓名": "劉淑美",
        "性別": "女",
        "年齡": 79,
        " 檢查部位": "Plain K.U.B.",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 400,
        "    成數": 100,
        "    總價": 400,
        "開單醫師": "盧泰華",
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "A0035189",
        "姓名": "陳錫湲",
        "性別": "女",
        "年齡": 39,
        " 檢查部位": "Plain K.U.B.",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "A0046231",
        "姓名": "王寶玉",
        "性別": "女",
        "年齡": 62,
        " 檢查部位": "Plain K.U.B.",
        "保險別": "自費",
        "    劑量": 1,
        "    單價": 0,
        "    成數": 100,
        "    總價": 0,
        "開單醫師": "體檢一醫師",
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    },
    {
        "日期": "113/01/30",
        "病歷號碼": "1289323",
        "姓名": "高振益",
        "性別": "男",
        "年齡": 55,
        " 檢查部位": "Plain K.U.B.",
        "保險別": "健保",
        "    劑量": 1,
        "    單價": 400,
        "    成數": 100,
        "    總價": 400,
        "開單醫師": "張孝欽",
        "報告醫師": "李瑞華",
        "辨識異常": "清單內沒有此檢查部位"
    }
];

